<script>
// --- Esperar a que Webflow est√© listo ---
function onWebflowReady(callback) {
  if (document.readyState === "complete" || document.readyState === "interactive") {
    requestAnimationFrame(callback);
  } else {
    document.addEventListener("DOMContentLoaded", callback);
  }
}

onWebflowReady(() => {
  console.log("üöÄ Webflow custom script iniciado");

  const PROXY_BASE_URL = "https://wb-folk-integration.vercel.app"; 
  const REDIRECT_URL = "https://outlook.office.com/bookwithme/user/4ad3a4c7802f4a0fa2d187eb587792d1@celerik.com/meetingtype/GbK9zDiqokWZVxJZ6X507w2?anonymous&ismsaljsauthenabled&ep=mlink";

  // Selecci√≥n de formularios
  const newsletterForm = document.querySelector('form[data-name="SuscribeEdgeForm"]');
  const contactForm    = document.querySelector('form[data-name="BookCall"]');

  console.log("üîç Formularios encontrados:", {
    newsletterForm: !!newsletterForm,
    contactForm: !!contactForm,
  });

  // ==========================================================
  // NEWSLETTER FORM
  // ==========================================================
  if (newsletterForm) {
    console.log("üìå Newsletter form inicializado");

    newsletterForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      console.log("üì® [Newsletter] Enviando...");

      const emailInput = newsletterForm.querySelector("input[name='email']");
      const email = emailInput?.value?.trim();

      console.log("üîé [Newsletter] Email capturado:", email);

      if (!email) {
        console.error("‚ùå [Newsletter] Email vac√≠o o no encontrado");
        newsletterForm.querySelector(".w-form-fail")?.classList.add("w--show");
        return;
      }

      try {
        console.log("üåê [Newsletter] Enviando al proxy:", PROXY_BASE_URL + "/api/folk/newsletter");

        const res = await fetch(`${PROXY_BASE_URL}/api/folk/newsletter`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });

        console.log("üì• [Newsletter] Respuesta:", res.status);

        if (!res.ok) throw new Error("Respuesta no OK del proxy");

        console.log("‚úÖ [Newsletter] Env√≠o exitoso ‚Üí Webflow success-state");
        newsletterForm.submit();

      } catch (err) {
        console.error("‚ùå [Newsletter] Error:", err);
        newsletterForm.querySelector(".w-form-fail")?.classList.add("w--show");
      }
    });
  }

  // ==========================================================
  // CONTACT FORM con redirecci√≥n y mapeo de campos
  // ==========================================================
  if (contactForm) {
    console.log("üìå Contact form inicializado");

    contactForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      console.log("üì® [Contact] Enviando informaci√≥n...");

      // Captura de datos crudos
      const formData = new FormData(contactForm);
      const rawPayload = Object.fromEntries(formData.entries());

      console.log("üìù [Contact] Payload capturado (raw):", rawPayload);

      // ---- Mapeo a estructura que espera la API ----
      const payload = {
        name: rawPayload.name || "",
        email: rawPayload.Email || "",
        company: rawPayload.Company || "",
        role: rawPayload.RoleTitle || "",
        country: rawPayload.CountryTZ || "",
        project: rawPayload.Description || "",
      };

      console.log("üîß [Contact] Payload mapeado para API:", payload);

      try {
        console.log("üåê [Contact] Enviando al proxy:", PROXY_BASE_URL + "/api/folk/contact");

        const res = await fetch(`${PROXY_BASE_URL}/api/folk/contact`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        console.log("üì• [Contact] Respuesta:", res.status);

        if (!res.ok) throw new Error("Respuesta no OK del proxy");

        console.log("‚úÖ [Contact] Env√≠o exitoso ‚Üí Webflow success-state");
        contactForm.submit();

        console.log("‚è≥ [Contact] Redireccionando en breve a:", REDIRECT_URL);

        setTimeout(() => {
          console.log("‚û°Ô∏è [Contact] Redirigiendo ahora...");
          window.location.href = REDIRECT_URL;
        }, 300);

      } catch (err) {
        console.error("‚ùå [Contact] Error enviando:", err);
        contactForm.querySelector(".w-form-fail")?.classList.add("w--show");
      }
    });
  }

});
</script>
