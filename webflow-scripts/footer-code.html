<!-- COOKIE BANNER -->
<div id="cookie-banner" class="cookie-banner hidden">
  <h3>Cookies</h3>
  <p>
    This site uses analytics cookies only. These cookies help us understand site
    usage to improve our services. See our
    <a href="/privacy-policy" target="_self">privacy policy</a>.
  </p>

  <div class="cookie-buttons">
    <button id="cookie-accept" class="accept-btn">Accept</button>
    <button id="cookie-reject" class="reject-btn">Reject</button>
  </div>
</div>

<style>
  .cookie-banner {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 320px;
    background: #fafafa;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    font-family: system-ui, sans-serif;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    z-index: 999999;
  }

  .cookie-banner.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .hidden {
    opacity: 0;
    pointer-events: none;
  }

  h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 20px;
    font-weight: 600;
    color: #0f142b;
  }

  p {
    font-size: 14px;
    color: #0f142b;
    margin-bottom: 20px;
    line-height: 1.4;
  }

  a {
    color: #000;
    text-decoration: underline;
  }

  .cookie-buttons {
    display: flex;
    gap: 10px;
  }

  .accept-btn,
  .reject-btn {
    width: 100%;
    padding: 10px 0;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border: none;
  }

  .accept-btn {
    background: #214ded;
    border: 2px solid #fff;
    color: #fff;
  }

  .reject-btn {
    background: #fff;
    border: 2px solid #000;
    color: #000;
  }
</style>

<script>
  const CONSENT_KEY = "cookie_consent_status";
  const EXPIRATION_MS = 24 * 60 * 60 * 1000; // 1 day

  function getStoredConsent() {
    const stored = localStorage.getItem(CONSENT_KEY);
    if (!stored) return null;

    try {
      const parsed = JSON.parse(stored);
      if (Date.now() > parsed.expireAt) {
        localStorage.removeItem(CONSENT_KEY);
        console.log("[Cookie Consent] Stored consent expired.");
        return null;
      }
      return parsed.value;
    } catch {
      return null;
    }
  }

  function storeConsent(value) {
    localStorage.setItem(
      CONSENT_KEY,
      JSON.stringify({
        value,
        expireAt: Date.now() + EXPIRATION_MS,
      })
    );
  }

  function applyClarityConsent(granted) {
    console.log("[Clarity] Applying consentV2:", granted);

    const payload = {
      analytics_Storage: granted ? "granted" : "denied",
    };

    // Retry until clarity() is ready
    let tries = 0;
    const timer = setInterval(() => {
      if (window.clarity) {
        clarity("consentv2", payload);
        console.log("[Clarity] consentv2 sent:", payload);
        clearInterval(timer);
      } else if (tries++ > 20) {
        clearInterval(timer);
        console.warn("[Clarity] clarity() not found after retries.");
      }
    }, 200);
  }

  document.addEventListener("DOMContentLoaded", function () {
    const banner = document.getElementById("cookie-banner");
    const storedConsent = getStoredConsent();

    if (!storedConsent) {
      banner.classList.add("visible");
      console.log("[Cookie Consent] Banner displayed.");
    } else {
      applyClarityConsent(storedConsent === "granted");
      console.log("[Cookie Consent] Using stored consent:", storedConsent);
    }

    document
      .getElementById("cookie-accept")
      .addEventListener("click", function () {
        console.log("[Cookie Consent] User accepted analytics cookies.");

        storeConsent("granted");
        applyClarityConsent(true);

        fadeOutBanner();
      });

    document
      .getElementById("cookie-reject")
      .addEventListener("click", function () {
        console.log("[Cookie Consent] User rejected analytics cookies.");

        storeConsent("denied");
        applyClarityConsent(false);

        fadeOutBanner();
      });
  });

  function fadeOutBanner() {
    const banner = document.getElementById("cookie-banner");
    banner.classList.remove("visible");
    banner.classList.add("hidden");

    setTimeout(() => {
      banner.style.display = "none";
      console.log("[Cookie Consent] Banner closed.");
    }, 400);
  }
</script>
